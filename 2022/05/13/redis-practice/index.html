<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>redis_practice | 穿过海的声音</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">redis_practice</h1><a id="logo" href="/.">穿过海的声音</a><p class="description">花开堪折直须折，莫待无花空折枝✌️</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">redis_practice</h1><div class="post-meta">2022-05-13</div><div class="post-content"><h3 id="仿大众点评系统"><a href="#仿大众点评系统" class="headerlink" title="仿大众点评系统"></a>仿大众点评系统</h3><h4 id="使用redis登陆验证操作"><a href="#使用redis登陆验证操作" class="headerlink" title="使用redis登陆验证操作"></a>使用redis登陆验证操作</h4><p>后台生成一个随机的六位数验证码，存储到redis（手机号为key）。</p>
<p>用户得到验证码后，在客户端输入，校验，若成功，保存用户到数据库，存储用户token到redis，保存用户到ThreadLocal（每一个线程内部都有一个ThreadLocal，用处见下面拦截器）</p>
<p>下一次同一个浏览器进来时，先看基于cookie的authorization中拿用户token，有的话先从redis拿，拿不到从数据库拿。</p>
<p>注意：一开始是校验码，用户token也是存在session中的（每一个浏览器访问时会有cookie，根据它里面的sessionID就能得到session）。因为多个tomcat之间不共享session存储空间，所以存储到了redis中，数据共享，内存存储也快，keyvalue结构，String类型。</p>
<p>若是没有登录的时候，需要用拦截器拦截某些需要用户登录的请求网址，所以把登陆校验流程都放到了拦截器中，但是每一个controller需要用户信息，所以存到了ThreadLocal中。（每一个进入Tomcat的请求都是一个独立的线程，将来ThreadLocal就会在线程内开辟一个空间保存对应的用户，不同用户有独立的线程）</p>
<p>但是拦截的时候，由于设置了用户一段时间不操作任何就会登出（redis的用户token的时间），那么有些没有拦截到的就不会刷新token。所以此处优化了拦截器，放了两个拦截器，第一个拦截器拦截所有，redis有用户的话，刷新token，后面那个是需要拦截的请求网址，要是不存在，拦截到登录界面。</p>
<h4 id="商铺缓存"><a href="#商铺缓存" class="headerlink" title="商铺缓存"></a>商铺缓存</h4><p>策略：</p>
<p>低一致性：内存淘汰</p>
<p>高一致性，主动更新缓存，并用超时剔除兜底。先操作数据库，再删除缓存（这样更新的时候只是读到旧数据，而先删，可能更新后还是一直读取到旧数据）。但得保证数据库和缓存操作同时成功或者失败：单体，事务；分布式，TOC等分布式事务方案。</p>
<p>注：缓存穿透、缓存雪崩、缓存击穿，见redis</p>
<h4 id="超卖问题"><a href="#超卖问题" class="headerlink" title="超卖问题"></a>超卖问题</h4><p>多个线程同时查询到有剩余，一起拿掉，就超卖了。</p>
<p>乐观锁CAS（成功率低，更新能用，插入用不了因为没有比较了），每次一发现库存没有被更改时时，才去设置。</p>
<p>但是悲观锁性能差。</p>
<h4 id="一个用户只能下一单"><a href="#一个用户只能下一单" class="headerlink" title="一个用户只能下一单"></a>一个用户只能下一单</h4><p>单机：此处是插入，所以不能CAS因为没有比较，用悲观锁</p>
<p>集群下：需要使用分布式锁。因为集群下，全新的Tomcat，全新的JVM，每个JVM都有自己的锁监视器，分布式锁可以多个JVM用同一把锁。1 Mysql本身的互斥锁机制能回滚。2 redis的setnx，可以锁超时释放，高可用，高性能。3 zookeeper节点的唯一性和互斥性，临时节点。</p>
<h5 id="基于redis的分布式锁"><a href="#基于redis的分布式锁" class="headerlink" title="基于redis的分布式锁"></a>基于redis的分布式锁</h5><p>添加锁（setnx）和超时（兜底）需要原子性，所以两句话改成一句话。</p>
<p>需要加线程标识（uuid区分jvm+线程ID区分线程），释放锁之前判断是否是当前线程与锁中的线程是否一致，一致才释放。</p>
<p>判断和释放也要原子性（Lua脚本），不然的话，判断完成被阻塞（如GC的STW），否则只能等锁超时释放。</p>
<p>优点：满足互斥行，故障时由于超时机制依然能释放，提高线程安全。利用集群可以保证高可用和高并发。</p>
<p>缺点：不可重入，不可重试，超时释放（业务执行时间更长），主从一致性（主节点拿到锁，未同步就宕机）。</p>
<h4 id="第三方"><a href="#第三方" class="headerlink" title="第三方"></a>第三方</h4><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网络。不仅提供了一系列的分布式java常用对象，还提供了许多分布式服务，包括分布式锁。</p>
<p>可重入锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>可重入锁原理：Lua保证原子性。获取锁不存在获取锁hash中的field（threadID）的value+1，已经存在则判断线程id标识是不是自己。释放锁，线程ID不是自己就返回，是自己的话，重入次数-1，重置有效期，若&#x3D;0删除key。</p>
<h5 id="Redisson分布式锁三个原理"><a href="#Redisson分布式锁三个原理" class="headerlink" title="Redisson分布式锁三个原理"></a>Redisson分布式锁三个原理</h5><ul>
<li>可重入：利用hash类型结构记录线程ID和重入次数，（不用setnx的string类型的了，所以lua需要原子操作，判断key是否存在，不存在获取，存在判断是否自己重入）</li>
<li>可重试：利用信号量和PubSub实现等待唤醒获取锁失败的重试机制</li>
<li>超时续约：利用watchDog，每隔一段时间重置（在锁需要无限时间的情况下）</li>
</ul>
<h5 id="Redisson分布式锁还有一个原理，主从一致性"><a href="#Redisson分布式锁还有一个原理，主从一致性" class="headerlink" title="Redisson分布式锁还有一个原理，主从一致性"></a>Redisson分布式锁还有一个原理，主从一致性</h5><p>multilock，对每一个主节点都获取锁成功，才能执行任务</p>
<h4 id="分布式锁总结"><a href="#分布式锁总结" class="headerlink" title="分布式锁总结"></a>分布式锁总结</h4><p><img src="https://pic.tyzhang.top/images/2022/05/26/IMG_F2CABAD1321B-1.jpg" alt="IMG_F2CABAD1321B-1.jpg"></p>
<h4 id="异步队列优化秒杀"><a href="#异步队列优化秒杀" class="headerlink" title="异步队列优化秒杀"></a>异步队列优化秒杀</h4><ol>
<li><p>先利用redis，判断库存余量（新增优惠券库存同时，直接保存到redis中）和校验一人一单（这两个放在lua中，原子操作），耗时短，需要速度快，完成抢单，所以放在redis中完成。</p>
</li>
<li><p>而查询优惠券，查询订单，减库存，创建订单4步都需要访问数据库，耗时长，利用独立线程异步下单。所以打算这两项分开。</p>
</li>
</ol>
<p>抢购成功，将优惠券id和用户id封装到阻塞队列，然后后面开启线程任务，不断从阻塞队列获取信息，实现异步下单。</p>
<h5 id="异步队列实现"><a href="#异步队列实现" class="headerlink" title="异步队列实现"></a>异步队列实现</h5><h6 id="基于List结构"><a href="#基于List结构" class="headerlink" title="基于List结构"></a>基于List结构</h6><p>LPUSH和BRPOP，或者RPUSH和BLPOP来实现。</p>
<p>优点：不受JVM内存限制。基于redis持久化，满足有序性</p>
<p>缺点：无法避免消息丢失（拿出后，未处理挂了），只支持单消费者</p>
<h6 id="基于PubSub消息队列"><a href="#基于PubSub消息队列" class="headerlink" title="基于PubSub消息队列"></a>基于PubSub消息队列</h6><p>优点：采用发布订阅模型，支持多生产、多消费</p>
<p>缺点：不支持数据持久化，无法避免消息丢失（发布的不会再redis保存），消息堆积有上限超出时数据丢失。</p>
<h6 id="基于Stream的消息队列"><a href="#基于Stream的消息队列" class="headerlink" title="基于Stream的消息队列"></a>基于Stream的消息队列</h6><p>Redis5.0新引入的一种数据类型，可以实现一个功能非常完善的消息队列。</p>
<p>&#x3D;&#x3D;消费者组&#x3D;&#x3D;：将多个消费者划分到一个组中，监听同一个队列。（多个客户端，可以同时读取不同的数据并行处理，加快了消费速度）。</p>
<p>优点：不受JVM内存限制。基于redis持久化，满足有序性</p>
<ol>
<li>消息可回溯（永久保存）</li>
<li>多个消费者争抢消息，加快消费速度</li>
<li>可以阻塞读取</li>
<li>没有漏读的风险，会标记上一个读取的</li>
<li>消息确认，保证消息至少被消费一次</li>
</ol>
<p>代码中使用Executors.newSingleThreadExecutor线程池去submit不断读取，若抛异常，处理pendinglist中没有得到ack的消息。</p>
<h4 id="探店笔记"><a href="#探店笔记" class="headerlink" title="探店笔记"></a>探店笔记</h4><p>上传图片返回地址，然后还有一些标题、正文、图片存储地址等数据，</p>
<h4 id="点赞功能"><a href="#点赞功能" class="headerlink" title="点赞功能"></a>点赞功能</h4><p>一个用户点击一次，set数据类型（无法排序，唯一）</p>
<p>所以，要加入根据用户点赞时间排序，可以使用SortedSet，以时间戳作为score</p>
<h4 id="共同关注"><a href="#共同关注" class="headerlink" title="共同关注"></a>共同关注</h4><p>关注的用户id，存储set数据类型，可以使用交集看共同好友。</p>
<h4 id="关注推送"><a href="#关注推送" class="headerlink" title="关注推送"></a>关注推送</h4><p>feed流。（&#x3D;&#x3D;timeline&#x3D;&#x3D;如朋友圈，智能排序如小红书推荐）</p>
<p>拉模式（读扩散）：放到发件箱，用户在读的时候，才拉取</p>
<p>&#x3D;&#x3D;推模式&#x3D;&#x3D;（写扩散）：要的时候，推送给每一个人，内存浪费</p>
<p>推拉结合：把粉丝分为大v（活跃粉丝 推速度快，普通粉丝 拉）和普通（粉丝少推）</p>
<p>一般用 推，kw以下级别，用推就好，因为拉实现复杂。新增探店笔记后，存储到数据库的同时，推送到粉丝的redis收件箱（根据时间戳排序），分页查询。</p>
<h4 id="附近店铺"><a href="#附近店铺" class="headerlink" title="附近店铺"></a>附近店铺</h4><h4 id="每日签到"><a href="#每日签到" class="headerlink" title="每日签到"></a>每日签到</h4></div><div class="tags"><a href="/tags/Java/"><i class="fa fa-tag"></i>Java</a><a href="/tags/Redis/"><i class="fa fa-tag"></i>Redis</a></div><div class="post-nav"><a class="next" href="/2022/05/13/redis-1/">redis_1</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/OJ/" style="font-size: 15px;">OJ</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Project/" style="font-size: 15px;">Project</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/05/13/redis-practice/">redis_practice</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/13/redis-1/">redis_1</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/%E5%8F%98%E6%B5%81%E5%99%A8%E8%B4%9F%E8%BD%BD%E8%AF%95%E9%AA%8C%E4%B8%AD%E7%9A%84%E8%83%BD%E9%87%8F%E5%9B%9E%E9%A6%88%E8%A3%85%E7%BD%AE/">变流器负载试验中的能量回馈装置</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/06/%E5%9F%BA%E4%BA%8E%E5%8D%95%E7%89%87%E6%9C%BA%E7%9A%84%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F/">基于单片机的远程控制系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/06/%E8%B6%85%E5%B8%82%E8%B4%AD%E7%89%A9%E6%9C%BA%E5%99%A8%E4%BA%BA/">超市购物机器人</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/22/HDU-Page11(2067%EF%BD%9E2080)%20/">HDU Page11(2067～2080)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/15/HDU-Page11(2059%EF%BD%9E2062)/">HDU-Page11(2059～2062)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/15/HDU-Page11-2041%EF%BD%9E2050%E9%80%92%E6%8E%A8/">HDU Page11(2041～2050)递推</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/15/HDU-Page11(2051%EF%BD%9E2065)/">HDU Page11(2051～2066)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/15/HDU-Page11(2081%EF%BD%9E2099)/">HDU-Page11(2081～2099)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">穿过海的声音.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>